var K=Object.defineProperty;var L=(l,e,r)=>e in l?K(l,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):l[e]=r;var C=(l,e,r)=>L(l,typeof e!="symbol"?e+"":e,r);import{aQ as o,P as S,q as P,d as G,ab as z,d_ as j,dZ as R,b as E,o as W,w as p,i as d,e as t,bJ as Q,bK as Z,E as k,bL as X,ad as ee,k as n,R as D,V as $,b0 as O,ai as te,ak as se,al as ae,aU as T,L as H,am as oe,an as V,dg as ie,ct as re,cu as ne,$ as Y,az as J,aB as le,J as de,ac as ce,t as A}from"./index-BQvMrvkP.js";import{u as he}from"./SettingsView-n6DnlGFR.js";import{H as fe}from"./hard-drive-BWbyzFjR.js";class ue{constructor(e){C(this,"backend",null);C(this,"isWatching",!1);C(this,"pollInterval",2e3);C(this,"intervalId",null);C(this,"fileSnapshots",new Map);C(this,"options",{});this.options=e||{},this.pollInterval=(e==null?void 0:e.pollInterval)||2e3}setBackend(e){this.backend=e}async start(){if(this.isWatching){o.warn("[FileWatcher] Already watching");return}if(!this.backend)throw new Error("FileWatcherService: Backend not set");o.info("[FileWatcher] Starting file watcher..."),this.isWatching=!0,await this.takeSnapshot(),this.intervalId=setInterval(async()=>{var e,r;try{await this.checkForChanges()}catch(u){o.error("[FileWatcher] Error checking for changes:",u),(r=(e=this.options).onError)==null||r.call(e,u)}},this.pollInterval),o.info(`[FileWatcher] Started watching (polling every ${this.pollInterval}ms)`)}stop(){this.isWatching&&(o.info("[FileWatcher] Stopping file watcher..."),this.isWatching=!1,this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null),this.fileSnapshots.clear(),o.info("[FileWatcher] File watcher stopped"))}isActive(){return this.isWatching}async takeSnapshot(){if(!this.backend)return;const e=this.backend.getDirectoryHandle();if(e)try{const r=new Map,u=e;for await(const[h,F]of u.entries())if(F.kind==="file"&&(h.endsWith(".nota")||h.endsWith(".json")))try{const x=await F.getFile(),m=h.replace(/\.(nota|json)$/,"").replace(/_/g,"-");r.set(h,{name:h,notaId:m,lastModified:x.lastModified,size:x.size})}catch(v){o.warn(`[FileWatcher] Failed to read file ${h}:`,v)}this.fileSnapshots=r,o.debug(`[FileWatcher] Snapshot taken: ${this.fileSnapshots.size} files`)}catch(r){throw o.error("[FileWatcher] Failed to take snapshot:",r),r}}async checkForChanges(){var r,u,h,F,v,x;if(!this.backend)return;const e=this.backend.getDirectoryHandle();if(e)try{const m=new Map,b=[],w=[],I=e;for await(const[s,i]of I.entries())if(i.kind==="file"&&(s.endsWith(".nota")||s.endsWith(".json")))try{const B=await i.getFile(),f=s.replace(/\.(nota|json)$/,"").replace(/_/g,"-"),a={name:s,notaId:f,lastModified:B.lastModified,size:B.size};m.set(s,a);const M=this.fileSnapshots.get(s);M?(M.lastModified!==a.lastModified||M.size!==a.size)&&b.push(s):w.push(s)}catch(c){o.warn(`[FileWatcher] Failed to read file ${s}:`,c)}const _=[];for(const[s,i]of this.fileSnapshots.entries())m.has(s)||_.push(s);if(this.fileSnapshots=m,b.length>0){o.info(`[FileWatcher] Files changed: ${b.join(", ")}`);for(const s of b){const i=m.get(s);if(i)try{const c=await this.backend.readNota(i.notaId);c&&((u=(r=this.options).onFileChanged)==null||u.call(r,i.notaId,c))}catch(c){o.error(`[FileWatcher] Failed to read changed file ${s}:`,c)}}}if(w.length>0){o.info(`[FileWatcher] Files added: ${w.join(", ")}`);for(const s of w){const i=m.get(s);if(i)try{const c=await this.backend.readNota(i.notaId);c&&((F=(h=this.options).onFileAdded)==null||F.call(h,i.notaId,c))}catch(c){o.error(`[FileWatcher] Failed to read added file ${s}:`,c)}}}if(_.length>0){o.info(`[FileWatcher] Files deleted: ${_.join(", ")}`);for(const s of _){const i=this.fileSnapshots.get(s);i&&((x=(v=this.options).onFileDeleted)==null||x.call(v,i.notaId))}}}catch(m){throw o.error("[FileWatcher] Failed to check for changes:",m),m}}setPollInterval(e){this.pollInterval=e,this.isWatching&&(this.stop(),this.start().catch(r=>{o.error("[FileWatcher] Failed to restart with new interval:",r)}))}getPollInterval(){return this.pollInterval}}let N=null;function ge(l){return N||(N=new ue(l)),N}const q="bashnota-storage-mode";let g=null;function me(){try{const l=localStorage.getItem(q);if(l){const e=JSON.parse(l);return{mode:e.mode||"indexeddb",autoWatch:e.autoWatch??!0,directoryHandle:null}}}catch(l){o.error("Failed to load storage mode config:",l)}return{mode:"indexeddb",autoWatch:!0,directoryHandle:null}}function U(l){try{const e={mode:l.mode,autoWatch:l.autoWatch};localStorage.setItem(q,JSON.stringify(e)),o.info("[StorageMode] Configuration saved:",e)}catch(e){o.error("Failed to save storage mode config:",e)}}const y=P(me());function pe(){const l=S({get:()=>y.value.mode,set:s=>{y.value.mode=s,U(y.value),o.info("[StorageMode] Mode changed to:",s)}}),e=S({get:()=>y.value.autoWatch,set:s=>{y.value.autoWatch=s,U(y.value),o.info("[StorageMode] Auto-watch changed to:",s),g&&(s&&y.value.mode==="filesystem"?g.start().catch(i=>{o.error("[StorageMode] Failed to start file watcher:",i)}):g.stop())}}),r=S(()=>typeof window<"u"&&"showDirectoryPicker"in window),u=S(()=>y.value.mode==="filesystem"),h=S(()=>y.value.mode==="indexeddb"),F=S(()=>(g==null?void 0:g.isActive())||!1),v=async()=>{if(!r.value)throw new Error("File System Access API is not supported in this browser");l.value="filesystem",o.info("[StorageMode] Switched to filesystem mode")},x=()=>{l.value="indexeddb",g&&g.stop(),o.info("[StorageMode] Switched to IndexedDB mode")},m=s=>{y.value.directoryHandle=s,o.info("[StorageMode] Directory handle updated")},b=()=>y.value.directoryHandle,w=(s,i)=>(g||(g=ge({pollInterval:2e3,onFileChanged:i==null?void 0:i.onFileChanged,onFileAdded:i==null?void 0:i.onFileAdded,onFileDeleted:i==null?void 0:i.onFileDeleted,onError:c=>{o.error("[StorageMode] File watcher error:",c)}})),g.setBackend(s),y.value.mode==="filesystem"&&y.value.autoWatch&&g.start().catch(c=>{o.error("[StorageMode] Failed to start file watcher:",c)}),g),I=()=>{g&&g.stop()},_=S(()=>{switch(y.value.mode){case"filesystem":return"Files are stored directly in a selected folder as .nota files. Changes to files in the folder are reflected in real-time.";case"indexeddb":return"Files are stored in the browser's IndexedDB. Data is stored locally in the browser.";default:return"Unknown storage mode"}});return{storageMode:l,autoWatch:e,isFilesystemSupported:r,isFilesystemMode:u,isIndexedDBMode:h,isWatchingFiles:F,getModeDescription:_,switchToFilesystem:v,switchToIndexedDB:x,setDirectoryHandle:m,getDirectoryHandle:b,initializeFileWatcher:w,stopFileWatcher:I}}const ye={class:"space-y-3"},ve={class:"flex items-center gap-2"},Fe={class:"flex items-center gap-2"},we={class:"flex items-center gap-2"},xe={key:0,class:"text-xs text-muted-foreground"},Se={class:"text-sm text-muted-foreground"},be={key:0,class:"space-y-3 pt-2 border-t"},_e={class:"flex items-center justify-between"},We={class:"space-y-0.5"},ke={key:0,class:"flex items-center gap-2 p-2 bg-muted rounded-md"},Ie={class:"flex items-start gap-2 p-3 bg-blue-50 dark:bg-blue-950/20 rounded-lg"},Me={key:1,class:"flex items-start gap-2 p-3 bg-amber-50 dark:bg-amber-950/20 rounded-lg"},Ce={key:2,class:"flex items-center justify-between p-3 bg-green-50 dark:bg-green-950/20 rounded-lg"},Ae={class:"flex items-start gap-2"},He=G({__name:"StorageModeSettings",setup(l){const e=he(),{storageMode:r,autoWatch:u,isFilesystemSupported:h,isFilesystemMode:F,isWatchingFiles:v,getModeDescription:x,switchToFilesystem:m,switchToIndexedDB:b}=pe(),w=P(!1),I=P(!1);z(()=>e.advancedSettings.storageMode,f=>{f!==r.value&&(r.value=f)},{immediate:!0}),z(()=>e.advancedSettings.filesystemAutoWatch,f=>{f!==u.value&&(u.value=f)},{immediate:!0});const _=async f=>{if(f!==r.value){w.value=!0;try{if(f==="filesystem"){if(!h.value){A.error("File System Access API Not Supported",{description:"Your browser does not support the File System Access API. Please use a modern browser like Chrome, Edge, or Opera."});return}try{await m(),e.updateCategory("advanced",{storageMode:"filesystem"}),A.success("Filesystem Mode Enabled",{description:"Please reload the page to apply changes. You will be prompted to select a directory for storing .nota files."}),I.value=!0}catch(a){o.error("Failed to enable filesystem mode:",a),A.error("Failed to Enable Filesystem Mode",{description:"Could not access the file system. Please check your browser permissions."})}}else b(),e.updateCategory("advanced",{storageMode:"indexeddb"}),A.success("IndexedDB Mode Enabled",{description:"Please reload the page to apply changes."}),I.value=!0}catch(a){o.error("Failed to change storage mode:",a),A.error("Failed to Change Storage Mode",{description:"An error occurred while changing the storage mode."})}finally{w.value=!1}}},s=f=>{u.value=f,e.updateCategory("advanced",{filesystemAutoWatch:f}),A.success(f?"Auto-Watch Enabled":"Auto-Watch Disabled",{description:f?"Changes to .nota files will be detected automatically.":"You will need to manually reload to see file changes."})},i=()=>{window.location.reload()},c=S(()=>F.value?j:R),B=S(()=>F.value?"File System":"IndexedDB");return(f,a)=>(W(),E(t(ce),null,{default:p(()=>[d(t(Q),null,{default:p(()=>[d(t(Z),{class:"flex items-center gap-2"},{default:p(()=>[d(t(fe),{class:"w-5 h-5"}),a[1]||(a[1]=k(" Storage Mode "))]),_:1}),d(t(X),null,{default:p(()=>a[2]||(a[2]=[k(" Choose how BashNota stores your notes ")])),_:1})]),_:1}),d(t(ee),{class:"space-y-6"},{default:p(()=>[n("div",ye,[d(t(O),null,{default:p(()=>a[3]||(a[3]=[k("Storage Backend")])),_:1}),d(t(te),{"model-value":t(r),"onUpdate:modelValue":a[0]||(a[0]=M=>{(M==="indexeddb"||M==="filesystem")&&_(M)}),disabled:w.value},{default:p(()=>[d(t(se),{class:"w-full"},{default:p(()=>[d(t(ae),null,{default:p(()=>[n("div",ve,[(W(),E(T(c.value),{class:"w-4 h-4"})),k(" "+H(B.value),1)])]),_:1})]),_:1}),d(t(oe),null,{default:p(()=>[d(t(V),{value:"indexeddb"},{default:p(()=>[n("div",Fe,[d(t(R),{class:"w-4 h-4"}),a[4]||(a[4]=k(" IndexedDB (Browser Storage) "))])]),_:1}),d(t(V),{value:"filesystem",disabled:!t(h)},{default:p(()=>[n("div",we,[d(t(j),{class:"w-4 h-4"}),a[5]||(a[5]=k(" File System (.nota files) ")),t(h)?$("",!0):(W(),D("span",xe," (Not Supported) "))])]),_:1},8,["disabled"])]),_:1})]),_:1},8,["model-value","disabled"]),n("p",Se,H(t(x)),1)]),t(F)?(W(),D("div",be,[n("div",_e,[n("div",We,[d(t(O),null,{default:p(()=>a[6]||(a[6]=[k("Auto-Watch Files")])),_:1}),a[7]||(a[7]=n("p",{class:"text-sm text-muted-foreground"}," Automatically detect changes to .nota files in the selected directory ",-1))]),d(t(ie),{checked:t(u),"onUpdate:checked":s},null,8,["checked"])]),t(u)?(W(),D("div",ke,[(W(),E(T(t(v)?t(re):t(ne)),{class:Y(["w-4 h-4",t(v)?"text-green-600 dark:text-green-400":"text-gray-400"])},null,8,["class"])),n("span",{class:Y(["text-sm",t(v)?"text-green-700 dark:text-green-300":"text-muted-foreground"])}," File watcher is "+H(t(v)?"active":"inactive"),3)])):$("",!0),n("div",Ie,[d(t(J),{class:"w-4 h-4 text-blue-600 dark:text-blue-400 mt-0.5 flex-shrink-0"}),a[8]||(a[8]=n("div",{class:"text-sm text-blue-700 dark:text-blue-300"},[n("p",{class:"font-medium mb-1"},"File System Mode Benefits:"),n("ul",{class:"list-disc list-inside space-y-1 text-xs"},[n("li",null,"Edit .nota files directly with any text editor"),n("li",null,"Real-time synchronization with file system"),n("li",null,"Easy backup and version control with git"),n("li",null,"Works across multiple instances of BashNota")])],-1))])])):$("",!0),t(h)?$("",!0):(W(),D("div",Me,[d(t(J),{class:"w-4 h-4 text-amber-600 dark:text-amber-400 mt-0.5 flex-shrink-0"}),a[9]||(a[9]=n("div",{class:"text-sm text-amber-700 dark:text-amber-300"},[n("p",{class:"font-medium mb-1"},"File System Mode Not Available"),n("p",{class:"text-xs"}," Your browser does not support the File System Access API. Please use Chrome, Edge, or Opera to enable this feature. ")],-1))])),I.value?(W(),D("div",Ce,[n("div",Ae,[d(t(le),{class:"w-4 h-4 text-green-600 dark:text-green-400 mt-0.5"}),a[10]||(a[10]=n("div",{class:"text-sm text-green-700 dark:text-green-300"},[n("p",{class:"font-medium"},"Reload Required"),n("p",{class:"text-xs"},"Please reload the page to apply storage mode changes")],-1))]),d(t(de),{size:"sm",variant:"default",onClick:i},{default:p(()=>a[11]||(a[11]=[k(" Reload Now ")])),_:1})])):$("",!0)]),_:1})]),_:1}))}});export{He as default};
