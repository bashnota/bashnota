var w=Object.defineProperty;var m=(c,e,t)=>e in c?w(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t;var y=(c,e,t)=>m(c,typeof e!="symbol"?e+"":e,t);import{aQ as i}from"./index-B6K4lM3_.js";import{g as F,v as u,s as p}from"./directoryHandleStorage-rrpEms-7.js";const g="1.0";class N{constructor(){y(this,"type","filesystem");y(this,"directoryHandle",null);y(this,"initialized",!1)}async isAvailable(){return typeof window<"u"&&"showDirectoryPicker"in window}async initialize(){try{i.info("[FileSystemBackend] Attempting to initialize with persisted handle...");const e=await F();if(!e)throw i.warn("[FileSystemBackend] No persisted directory handle found"),new Error("No directory handle available. User must select a directory first.");if(!await u(e))throw i.warn("[FileSystemBackend] Permission denied for persisted directory handle"),new Error("Permission denied for directory. User must grant access again.");this.directoryHandle=e,this.initialized=!0,i.info("[FileSystemBackend] Initialized successfully with persisted handle")}catch(e){throw i.error("[FileSystemBackend] Failed to initialize:",e),e}}async readNota(e){var t;this.ensureInitialized();try{const a=[".nota",".json"];for(const n of a)try{const d=`${e.replace(/[^a-zA-Z0-9-_]/g,"_")}${n}`,s=await(await(await this.directoryHandle.getFileHandle(d,{create:!1})).getFile()).text(),h=JSON.parse(s),l=h.nota||h;return l.createdAt&&(l.createdAt=new Date(l.createdAt)),l.updatedAt&&(l.updatedAt=new Date(l.updatedAt)),i.debug(`[FileSystemBackend] Read nota: ${e} from ${d}`),l}catch(r){if(r.name==="NotFoundError"||(t=r.message)!=null&&t.includes("NotFoundError"))continue;throw r}return null}catch(a){return i.error(`[FileSystemBackend] Failed to read nota ${e}:`,a),null}}async writeNota(e){this.ensureInitialized();try{const t=this.getNotaFileName(e.id),n=await(await this.directoryHandle.getFileHandle(t,{create:!0})).createWritable(),r={version:g,exportedAt:new Date().toISOString(),nota:e},d=JSON.stringify(r,null,2);await n.write(d),await n.close(),i.debug(`[FileSystemBackend] Wrote nota: ${e.id}`)}catch(t){throw i.error(`[FileSystemBackend] Failed to write nota ${e.id}:`,t),t}}async deleteNota(e){var t;this.ensureInitialized();try{const a=e.replace(/[^a-zA-Z0-9-_]/g,"_"),n=[".nota",".json"];let r=!1;for(const d of n)try{const o=`${a}${d}`;await this.directoryHandle.removeEntry(o),i.debug(`[FileSystemBackend] Deleted nota: ${e} (${o})`),r=!0}catch(o){if(o.name==="NotFoundError"||(t=o.message)!=null&&t.includes("NotFoundError"))continue;throw o}r||i.debug(`[FileSystemBackend] Nota file not found: ${e} (already deleted or never existed)`)}catch(a){throw i.error(`[FileSystemBackend] Failed to delete nota ${e}:`,a),a}}async listNotas(){this.ensureInitialized();const e=[];try{const t=this.directoryHandle;for await(const[a,n]of t.entries())if(n.kind==="file"&&(a.endsWith(".nota")||a.endsWith(".json")))try{const o=await(await n.getFile()).text(),f=JSON.parse(o),s=f.nota||f;s.createdAt&&(s.createdAt=new Date(s.createdAt)),s.updatedAt&&(s.updatedAt=new Date(s.updatedAt)),e.push(s)}catch{i.warn(`[FileSystemBackend] Failed to parse file ${n.name}, skipping`)}return i.debug(`[FileSystemBackend] Listed ${e.length} notas`),e}catch(t){return i.error("[FileSystemBackend] Failed to list notas:",t),[]}}ensureInitialized(){if(!this.initialized||!this.directoryHandle)throw new Error("FileSystemBackend not initialized. Call initialize() first.")}getNotaFileName(e){return`${e.replace(/[^a-zA-Z0-9-_]/g,"_")}.nota`}async watchDirectory(e){this.ensureInitialized();try{i.info("[FileSystemBackend] Directory watching not yet implemented")}catch(t){i.error("[FileSystemBackend] Failed to watch directory:",t)}}async readNotaFile(e){try{const a=await(await e.getFile()).text(),n=JSON.parse(a),r=n.nota||n;return r.createdAt&&(r.createdAt=new Date(r.createdAt)),r.updatedAt&&(r.updatedAt=new Date(r.updatedAt)),i.debug(`[FileSystemBackend] Read .nota file: ${r.id}`),r}catch(t){return i.error("[FileSystemBackend] Failed to read .nota file:",t),null}}getDirectoryHandle(){return this.directoryHandle}async setDirectoryHandle(e){try{if(!await u(e))throw new Error("Permission denied for directory");await p(e),this.directoryHandle=e,this.initialized=!0,i.info("[FileSystemBackend] Directory handle set and persisted")}catch(t){throw i.error("[FileSystemBackend] Failed to set directory handle:",t),t}}}export{N as FileSystemBackend};
