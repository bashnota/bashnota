import{O as R,a7 as W,cp as J,q as M,a5 as U,aQ as p,t as k,dd as z}from"./index-dr6P1g6z.js";function Q(P={}){const j=R(),E=W(),b=J(),m=M(!1),I=M(0),l={navigateToNota:!0,...P},L=async(t=[U.nota])=>new Promise(o=>{const r=document.createElement("input");r.type="file",r.accept=t.join(","),r.onchange=async e=>{var c,u,n;const i=(c=e.target.files)==null?void 0:c[0];if(i)try{m.value=!0;const a=await E.importNotas(i);if(a.length>0){await E.loadNotas(),k("Notas imported successfully");const s=a[0].id;l.navigateToNota&&j.push(`/nota/${s}`),(u=l.onSuccess)==null||u.call(l,s),o(!0)}else o(!1)}catch(a){p.error("Import failed:",a);const s=a instanceof Error?a:new Error("Import failed");k("Failed to import notas",{description:"Import Error"}),(n=l.onError)==null||n.call(l,s),o(!1)}finally{m.value=!1}else o(!1)},r.oncancel=()=>o(!1),r.click()}),q=async()=>new Promise(t=>{const o=document.createElement("input");o.type="file",o.accept=".ipynb",o.onchange=async r=>{var i,c,u;const e=(i=r.target.files)==null?void 0:i[0];if(e)try{if(!e.name.endsWith(".ipynb")){k("Please select a .ipynb file",{description:"Invalid File"}),t(!1);return}m.value=!0;const n=await F(e),a=JSON.parse(n),s=T(a,e.name),d=await E.createItem(s);await b.initializeNotaBlocks(d.id,s);const g=S(a),v=[];for(let f=0;f<g.length;f++){const w=g[f];try{const x=$(w,f,d.id);x&&v.push(x)}catch(x){p.warn("Failed to convert cell:",x,w),v.push(y(`[Failed to convert cell: ${w.cell_type||"unknown"}]`,f,d.id))}}for(const f of v)try{await z.saveBlock(f)}catch(w){p.error("Failed to save block:",w,f)}const h=await b.getBlockStructure(d.id);h&&(h.blockOrder=v.map(f=>f.id).filter(Boolean),h.version++,h.lastModified=new Date,await b.saveBlockStructure(h)),k(`Notebook "${s}" imported successfully`),l.navigateToNota&&j.push(`/nota/${d.id}`),(c=l.onSuccess)==null||c.call(l,d.id),t(!0)}catch(n){p.error("Failed to import notebook:",n);const a=n instanceof Error?n:new Error("Failed to import notebook");k("Failed to import the notebook file",{description:"Import Failed"}),(u=l.onError)==null||u.call(l,a),t(!1)}finally{m.value=!1,o.value=""}else t(!1)},o.oncancel=()=>t(!1),o.click()}),F=t=>new Promise((o,r)=>{const e=new FileReader;e.onload=i=>{var c;return o((c=i.target)==null?void 0:c.result)},e.onerror=()=>r(new Error("Failed to read file")),e.readAsText(t)}),y=(t,o,r)=>({type:"text",order:o,notaId:r,content:t,createdAt:new Date,updatedAt:new Date,version:1}),N=(t,o,r,e)=>({type:"heading",order:r,notaId:e,content:t,level:o,createdAt:new Date,updatedAt:new Date,version:1}),_=(t,o,r,e,i)=>({type:"executableCodeBlock",order:e,notaId:i,content:t,language:o,output:r||null,sessionId:null,isExecuting:!1,executionTime:null,error:null,kernelPreferences:null,createdAt:new Date,updatedAt:new Date,version:1}),T=(t,o)=>{var r,e,i,c;try{if((r=t.metadata)!=null&&r.title)return t.metadata.title;if((e=t.info)!=null&&e.title)return t.info.title;if(t.name)return t.name;if(t.cells&&Array.isArray(t.cells)){for(const n of t.cells)if(n.cell_type==="markdown"&&n.source&&Array.isArray(n.source)){const a=(i=n.source[0])==null?void 0:i.trim();if(a&&a.startsWith("#"))return a.replace(/^#+\s*/,"")}}if(t.worksheets&&Array.isArray(t.worksheets)){for(const n of t.worksheets)if(n.cells&&Array.isArray(n.cells)){for(const a of n.cells)if(a.cell_type==="markdown"&&a.source&&Array.isArray(a.source)){const s=(c=a.source[0])==null?void 0:c.trim();if(s&&s.startsWith("#"))return s.replace(/^#+\s*/,"")}}}const u=o.replace(/\.(ipynb|json)$/i,"");return u&&u!==o?u:"Imported Notebook"}catch(u){return p.error("Error extracting notebook title:",u),o.replace(/\.(ipynb|json)$/i,"")||"Imported Notebook"}},S=t=>{var o,r;try{let e=t.cells;if(!e&&t.worksheets?e=((o=t.worksheets[0])==null?void 0:o.cells)||[]:!e&&t.sheets&&(e=((r=t.sheets[0])==null?void 0:r.cells)||[]),!e||!Array.isArray(e))throw new Error("Invalid notebook format: no cells found");return e}catch(e){throw p.error("Error converting notebook to nota format:",e,t),new Error(`Failed to convert notebook: ${e instanceof Error?e.message:"Unknown error"}`)}},$=(t,o,r)=>{try{const e=t.cell_type||t.type||"unknown";switch(e){case"markdown":return A(t,o,r);case"code":return B(t,o,r);case"raw":return C(t,o,r);case"heading":return A(t,o,r);default:return p.warn("Unknown cell type:",e,"Cell:",t),A(t,o,r)}}catch(e){return p.error("Error converting notebook cell:",e,t),y(`[Error converting cell: ${t.cell_type||"unknown"}]`,o,r)}},A=(t,o,r)=>{try{let e="";if(Array.isArray(t.source)?e=t.source.join(""):typeof t.source=="string"?e=t.source:t.text?e=Array.isArray(t.text)?t.text.join(""):t.text:t.content&&(e=Array.isArray(t.content)?t.content.join(""):t.content),!e||!e.trim())return null;if(t.cell_type==="heading"||t.type==="heading"){const c=t.level||1,u=e.trim().replace(/^#+\s*/,"");return N(u,c,o,r)}const i=e.trim().match(/^(#{1,6})\s+(.+)$/);if(i){const c=i[1].length,u=i[2].trim();return N(u,c,o,r)}return y(e,o,r)}catch(e){return p.error("Error converting markdown cell:",e,t),y("[Error converting markdown cell]",o,r)}},B=(t,o,r)=>{var e,i,c,u,n;try{let a="";if(Array.isArray(t.source)?a=t.source.join(""):typeof t.source=="string"?a=t.source:t.input?a=Array.isArray(t.input)?t.input.join(""):t.input:t.code&&(a=Array.isArray(t.code)?t.code.join(""):t.code),!a||!a.trim())return null;let s="python";(e=t.metadata)!=null&&e.language?s=t.metadata.language:(c=(i=t.metadata)==null?void 0:i.kernelspec)!=null&&c.language?s=t.metadata.kernelspec.language:(n=(u=t.metadata)==null?void 0:u.kernel_spec)!=null&&n.language?s=t.metadata.kernel_spec.language:t.language&&(s=t.language),s={python:"python",python3:"python",python2:"python",javascript:"javascript",js:"javascript",typescript:"typescript",ts:"typescript",r:"r",julia:"julia",matlab:"matlab",octave:"octave",bash:"bash",shell:"bash",sh:"bash",sql:"sql",html:"html",css:"css",cpp:"cpp","c++":"cpp",c:"c",java:"java",scala:"scala",go:"go",rust:"rust",swift:"swift",kotlin:"kotlin",php:"php",ruby:"ruby",perl:"perl"}[s.toLowerCase()]||"python";let g="";return t.outputs&&Array.isArray(t.outputs)&&(g=D(t.outputs)),_(a,s,g,o,r)}catch(a){return p.error("Error converting code cell:",a,t),y("[Error converting code cell]",o,r)}},C=(t,o,r)=>{try{let e="";return Array.isArray(t.source)?e=t.source.join(""):typeof t.source=="string"?e=t.source:t.text?e=Array.isArray(t.text)?t.text.join(""):t.text:t.content&&(e=Array.isArray(t.content)?t.content.join(""):t.content),!e||!e.trim()?null:y(e,o,r)}catch(e){return p.error("Error converting raw cell:",e,t),y("[Error converting raw cell]",o,r)}},D=t=>{let o="";for(const r of t)try{r.output_type==="stream"?o+=Array.isArray(r.text)?r.text.join(""):r.text||"":r.output_type==="execute_result"||r.output_type==="display_data"?r.data&&r.data["text/plain"]&&(o+=Array.isArray(r.data["text/plain"])?r.data["text/plain"].join(""):r.data["text/plain"]):r.output_type==="error"&&(o+=`Error: ${r.ename}: ${r.evalue}
`,r.traceback&&(o+=r.traceback.join(`
`)))}catch(e){p.warn("Failed to convert output:",e,r)}return o.trim()};return{isImporting:m,importProgress:I,importNota:L,importJupyterNotebook:q,readFileAsText:F,extractNotebookTitle:T,convertNotebookToNota:S,convertNotebookCell:$,convertMarkdownCell:A,convertCodeCell:B,convertRawCell:C,convertNotebookOutputs:D,createTextBlock:y,createHeadingBlock:N,createExecutableCodeBlock:_}}export{Q as useNotaImport};
